<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Video Analysis — Classroom AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-md);
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      transition: all var(--t-med);
      position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--blue-light);
      background: rgba(59,130,246,0.04);
    }
    .upload-zone input[type=file] {
      position: absolute; inset: 0;
      opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }
    .upload-zone i { font-size: 2.8rem; color: var(--border-hover); margin-bottom: 12px; }
    .upload-zone-text { font-size: 0.92rem; color: var(--text-secondary); }
    .upload-zone-sub  { font-size: 0.78rem; color: var(--text-muted); margin-top: 6px; }

    .analysis-layout {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
      align-items: start;
    }

    .vid-wrap {
      position: relative;
      background: #000;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    #uploadVideo { width: 100%; height: auto; display: block; }
    #uploadCanvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    .summary-box {
      background: linear-gradient(135deg, rgba(29,78,216,0.1), rgba(6,182,212,0.05));
      border: 1px solid rgba(29,78,216,0.25);
      border-radius: var(--radius-md);
      padding: 24px;
    }

    @media (max-width: 900px) {
      .analysis-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-brand">
      <img src="kseflogo.png" alt="KSEF" class="sidebar-brand-logo">
      <div class="sidebar-brand-text">
        <span class="sidebar-brand-name">Classroom AI</span>
        <span class="sidebar-brand-sub">62nd KSEF · 2026</span>
      </div>
    </div>
    <nav class="sidebar-nav">
      <span class="nav-section-label">Monitor</span>
      <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
      <a href="livefeed.html" class="nav-link"><i class="fas fa-broadcast-tower"></i><span>Live Feed</span></a>
      <a href="cctv_room.html" class="nav-link"><i class="fas fa-video"></i><span>CCTV Room</span></a>
      <a href="upload.html" class="nav-link"><i class="fas fa-film"></i><span>Video Analysis</span></a>
      <span class="nav-section-label">Library</span>
      <a href="videos.html" class="nav-link"><i class="fas fa-photo-video"></i><span>Video Library</span></a>
      <span class="nav-section-label">Insights</span>
      <a href="statistics.html" class="nav-link"><i class="fas fa-chart-line"></i><span>Statistics</span></a>
      <a href="report.html" class="nav-link"><i class="fas fa-file-alt"></i><span>Session Report</span></a>
      <span class="nav-section-label">System</span>
      <a href="settings.html" class="nav-link"><i class="fas fa-sliders"></i><span>Settings</span></a>
      <a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i><span>About</span></a>
      <a href="help.html" class="nav-link"><i class="fas fa-circle-question"></i><span>Help</span></a>
    </nav>
    <div class="sidebar-footer">Precious Lydiah &amp; Shirleen Wambui<br>Maryhill Girls High School</div>
  </aside>

  <header class="topbar">
    <button class="topbar-toggle topbar-btn" id="sidebarToggle"><i class="fas fa-bars"></i></button>
    <h1 class="topbar-title">Video Analysis</h1>
    <div class="topbar-actions">
      <span id="topbarClock" style="font-size:0.82rem;color:var(--text-muted);"></span>
      <button class="topbar-btn" id="darkModeToggle"><i id="darkModeIcon" class="fas fa-moon"></i></button>
      <div class="user-chip"><div class="user-avatar">PL</div><span>Precious &amp; Shirleen</span></div>
    </div>
  </header>

  <main class="main-content">

    <!-- Upload zone -->
    <div class="glass-card mb-16" id="uploadSection">
      <div class="card-title mb-16"><i class="fas fa-cloud-upload-alt"></i> Upload Classroom Video</div>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept="video/*">
        <i class="fas fa-film"></i>
        <div class="upload-zone-text">Drag &amp; drop a video file, or click to browse</div>
        <div class="upload-zone-sub">Supports MP4, WebM, MOV · AI will analyse each frame</div>
      </div>
    </div>

    <!-- Analysis section (hidden until video loaded) -->
    <div id="analysisSection" style="display:none;">

      <div class="flex items-center gap-12 mb-16">
        <div style="font-family:var(--font-head);font-size:0.95rem;font-weight:600;" id="videoFileName">—</div>
        <div style="flex:1;"></div>
        <button class="btn btn-ghost" id="changeVideoBtn"><i class="fas fa-folder-open"></i> Change</button>
        <button class="btn btn-primary" id="analyseBtn"><i class="fas fa-play"></i> Analyse</button>
        <button class="btn btn-danger" id="stopAnalysisBtn" disabled><i class="fas fa-stop"></i> Stop</button>
      </div>

      <div class="analysis-layout">
        <!-- Video -->
        <div>
          <div class="vid-wrap">
            <video id="uploadVideo" controls></video>
            <canvas id="uploadCanvas"></canvas>
          </div>
          <div class="glass-card mt-16">
            <div class="grid-3" style="gap:20px;">
              <div class="meter-wrap">
                <div class="meter-label"><span>Class Attention</span><span id="uAttVal">—</span></div>
                <div class="meter-track"><div class="meter-fill cyan" id="uAttMeter" style="width:0%"></div></div>
              </div>
              <div class="meter-wrap">
                <div class="meter-label"><span>Students in Frame</span><span id="uStudVal">0</span></div>
                <div class="meter-track"><div class="meter-fill blue" id="uStudMeter" style="width:0%"></div></div>
              </div>
              <div class="meter-wrap">
                <div class="meter-label"><span>Alert Events</span><span id="uAlertVal">0</span></div>
                <div class="meter-track"><div class="meter-fill red" id="uAlertMeter" style="width:0%"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel -->
        <div style="display:flex;flex-direction:column;gap:16px;">
          <!-- Student list -->
          <div class="glass-card">
            <div class="card-title mb-12"><i class="fas fa-users"></i> Current Frame</div>
            <div id="uStudentList" style="display:flex;flex-direction:column;gap:8px;">
              <div class="text-muted" style="font-size:0.82rem;text-align:center;padding:16px 0;">Press Analyse to start</div>
            </div>
          </div>

          <!-- Summary (shown after analysis) -->
          <div class="summary-box" id="summaryBox" style="display:none;">
            <div style="font-family:var(--font-head);font-size:1rem;font-weight:700;margin-bottom:16px;color:var(--cyan);">
              <i class="fas fa-chart-bar"></i> Analysis Summary
            </div>
            <div id="summaryContent"></div>
          </div>

          <!-- Event log -->
          <div class="glass-card">
            <div class="card-title mb-12"><i class="fas fa-list"></i> Events</div>
            <div class="event-log" id="uEventLog" style="max-height:200px;">
              <div class="text-muted" style="font-size:0.82rem;text-align:center;padding:16px 0;">No events yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
<script src="js/logger.js"></script>
<script src="js/app.js"></script>
<script src="js/ai-engine.js"></script>
<script>
  const fileInput      = document.getElementById('fileInput');
  const uploadZone     = document.getElementById('uploadZone');
  const uploadSection  = document.getElementById('uploadSection');
  const analysisSection= document.getElementById('analysisSection');
  const videoFileNameEl= document.getElementById('videoFileName');
  const uploadVideo    = document.getElementById('uploadVideo');
  const uploadCanvas   = document.getElementById('uploadCanvas');
  const analyseBtn     = document.getElementById('analyseBtn');
  const stopAnalysisBtn= document.getElementById('stopAnalysisBtn');
  const changeVideoBtn = document.getElementById('changeVideoBtn');
  const uStudentList   = document.getElementById('uStudentList');
  const uEventLog      = document.getElementById('uEventLog');
  const summaryBox     = document.getElementById('summaryBox');
  const summaryContent = document.getElementById('summaryContent');

  const uAtt  = { el: document.getElementById('uAttVal'),   bar: document.getElementById('uAttMeter')   };
  const uStud = { el: document.getElementById('uStudVal'),  bar: document.getElementById('uStudMeter')  };
  const uAlert= { el: document.getElementById('uAlertVal'), bar: document.getElementById('uAlertMeter') };

  let analysisRunning = false;
  let alertCount = 0;
  const bCounts = {};
  const attList = [];

  function setMeter(obj, pct, label = null) {
    obj.bar.style.width = Math.min(100, pct) + '%';
    obj.el.textContent  = label ?? (Math.round(pct) + '%');
  }

  function addULog(text, severity = 0) {
    const dotC = ['green','cyan','amber','red'][Math.min(severity,3)];
    const li = document.createElement('div');
    li.className = 'log-item';
    li.innerHTML = `<div class="log-dot ${dotC}"></div><div class="log-body"><div class="log-text">${text}</div><div class="log-time">${fmtTime(Date.now())}</div></div>`;
    if (uEventLog.querySelector('.text-muted')) uEventLog.innerHTML = '';
    uEventLog.prepend(li);
  }

  // Preload models automatically
  (async function preload() {
    if (!AIEngine.modelsLoaded) {
      AIEngine.loadModels().catch(e => console.error(e));
    }
  })();

  // File selection
  fileInput.addEventListener('change', loadVideo);
  uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
  uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
  uploadZone.addEventListener('drop', e => {
    e.preventDefault(); uploadZone.classList.remove('drag-over');
    const f = e.dataTransfer.files[0];
    if (f && f.type.startsWith('video/')) loadVideoFile(f);
  });

  changeVideoBtn.addEventListener('click', () => {
    if (analysisRunning) AIEngine.stop();
    uploadSection.style.display = 'block';
    analysisSection.style.display = 'none';
    uploadVideo.src = '';
    Object.keys(bCounts).forEach(k => delete bCounts[k]);
    attList.length = 0; alertCount = 0;
    summaryBox.style.display = 'none';
  });

  function loadVideo() {
    const f = fileInput.files[0];
    if (!f) return;
    loadVideoFile(f);
  }

  function loadVideoFile(file) {
    videoFileNameEl.textContent = file.name;
    uploadVideo.src = URL.createObjectURL(file);
    uploadSection.style.display = 'none';
    analysisSection.style.display = 'block';
    summaryBox.style.display = 'none';
    addULog('Video loaded: ' + file.name, 0);
  }

  function loadVideoFromUrl(url, name) {
    videoFileNameEl.textContent = name || url.split('/').pop();
    uploadVideo.src = url;
    uploadSection.style.display = 'none';
    analysisSection.style.display = 'block';
    summaryBox.style.display = 'none';
    addULog('Video loaded from library: ' + (name || url), 0);
  }

  // Auto-load from Video Library (via sessionStorage)
  (function checkSessionStorageVideo() {
    const url  = sessionStorage.getItem('analyse_video_url');
    const name = sessionStorage.getItem('analyse_video_name');
    if (url) {
      sessionStorage.removeItem('analyse_video_url');
      sessionStorage.removeItem('analyse_video_name');
      loadVideoFromUrl(url, name);
    }
  })();

  analyseBtn.addEventListener('click', async () => {
    analyseBtn.disabled = true;
    stopAnalysisBtn.disabled = false;
    summaryBox.style.display = 'none';

    // Load models (cached if already loaded)
    if (!AIEngine.modelsLoaded) {
      addULog('Loading AI models…', 0);
      try {
        await AIEngine.loadModels((msg) => addULog(msg, 0));
      } catch(e) {
        showToast('Failed to load AI models', 'error');
        analyseBtn.disabled = false; stopAnalysisBtn.disabled = true;
        return;
      }
    }

    uploadVideo.loop = true; uploadVideo.play();
    addULog('▶ Analysis started', 0);
    analysisRunning = true;

    AIEngine.start(uploadVideo, uploadCanvas, {
      interval: 600,

      onDetect(results) {
        const count = results.length;
        setMeter(uStud, count * 15, count.toString());

        const att = AIEngine.computeAttentionScore(results);
        attList.push(att);
        setMeter(uAtt, att);

        results.forEach(r => {
          const lbl = r.behaviour.label;
          bCounts[lbl] = (bCounts[lbl]||0) + 1;
        });

        // Update student list
        if (count === 0) {
          uStudentList.innerHTML = '<div class="text-muted" style="font-size:0.82rem;text-align:center;padding:12px 0;">No faces in frame</div>';
        } else {
          uStudentList.innerHTML = results.map((r,i) => {
            const b = r.behaviour;
            return `<div class="detection-card">
              <div class="detection-avatar">S${i+1}</div>
              <div class="detection-info">
                <div class="detection-name">Student ${i+1}</div>
              </div>
              <span class="behavior-badge ${b.badge}" style="font-size:0.7rem;padding:3px 8px;">${b.icon} ${b.label}</span>
            </div>`;
          }).join('');
        }
      },

      onLog(entry) {
        if (entry.behaviour.severity >= 2) {
          alertCount++;
          uAlert.el.textContent = alertCount;
          setMeter(uAlert, Math.min(100, alertCount * 10), alertCount.toString());
          addULog(`Student ${entry.id.slice(1)}: <strong>${entry.current}</strong>`, entry.severity);
        }
      }
    });
  });

  stopAnalysisBtn.addEventListener('click', () => {
    AIEngine.stop();
    uploadVideo.pause();
    analysisRunning = false;
    stopAnalysisBtn.disabled = true;
    analyseBtn.disabled = false;
    showSummary();
    addULog('⏹ Analysis stopped', 0);
  });

  uploadVideo.addEventListener('ended', () => {
    AIEngine.stop();
    analysisRunning = false;
    stopAnalysisBtn.disabled = true;
    analyseBtn.disabled = false;
    showSummary();
    addULog('✅ Video analysis complete', 0);
    showToast('Analysis complete!', 'success');
  });

  function showSummary() {
    if (!Object.keys(bCounts).length) return;
    const avgAtt = attList.length ? Math.round(attList.reduce((s,v)=>s+v,0)/attList.length) : 0;
    const top = Object.entries(bCounts).sort(([,a],[,b])=>b-a)[0];
    const badgeMap = {'Attentive':'attentive','Engaged':'engaged','Alert':'alert-b','Disengaged':'disengaged','Anxious':'anxious','Disruptive':'disruptive','Suspicious':'suspicious','Confused':'confused'};

    summaryContent.innerHTML = `
      <div style="margin-bottom:12px;">
        <div style="font-size:0.78rem;color:var(--text-muted);">Average Attention</div>
        <div style="font-family:var(--font-head);font-size:1.8rem;font-weight:700;">${avgAtt}%</div>
      </div>
      <div style="margin-bottom:12px;">
        <div style="font-size:0.78rem;color:var(--text-muted);">Dominant Behaviour</div>
        <span class="behavior-badge ${badgeMap[top?.[0]]||'attentive'}" style="margin-top:4px;display:inline-flex;">${top?.[0]||'—'}</span>
      </div>
      <div style="margin-bottom:12px;">
        <div style="font-size:0.78rem;color:var(--text-muted);">Alert Events</div>
        <div style="font-weight:700;color:var(--red);">${alertCount}</div>
      </div>
      <hr class="divider">
      ${Object.entries(bCounts).sort(([,a],[,b])=>b-a).map(([lbl,cnt])=>`
        <div class="flex items-center justify-between gap-8" style="margin-bottom:6px;">
          <span class="behavior-badge ${badgeMap[lbl]||'attentive'}" style="font-size:0.7rem;padding:2px 8px;">${lbl}</span>
          <span style="font-size:0.78rem;color:var(--text-muted);">${cnt}</span>
        </div>`).join('')}`;

    summaryBox.style.display = 'block';

    // Save session
    AIEngine.saveSession({
      type: 'video',
      maxStudents: Math.max(...Object.values(bCounts)),
      avgAttention: avgAtt,
      alerts: alertCount,
      duration: Math.round(uploadVideo.duration * 1000),
      behaviourCounts: { ...bCounts },
    });
  }
</script>
</body>
</html>
